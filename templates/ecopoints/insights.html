{% extends 'ecopoints/base.html' %}
{% load staticfiles %}

{% block title_block %}
    insights
{% endblock %}
{% block body_block %}
    <img src="{% static 'images/ecopoints_rainbow.png' %}" alt="Ecopoints Logo" />
    {% if is_authenticated %}

        <h2>Insights</h2>
        <div id="bubble-plot"></div>
        <p>Click on a month (bar within graph) to update contents shown in the bubble chart.</p>
        <h3>Daily Summary</h3>
        <p>You have earned <strong>{{ daily_points }}</strong> ecopoints today.</p>
        <br>
        <h3>Weekly Summary</h3>
        <p>You have earned <strong>{{ weekly_points }}</strong> ecopoints this week.</p>
        <br>
        <h3>Monthly Summary</h3>
        <p>You have earned <strong> {{ monthly_points }}</strong> ecopoints this month.</p>
        <div id="annual-histogram"></div>

    {% else %}
        <p>You are not logged in. Log in to see your insights.</p>
    {% endif %}
    <a href="{% url 'index' %}">Back to Home</a>

    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

    <script>
        window.onload = function() {
            {% if is_authenticated %}
                let latestMonth = {{ latest_month|default:"null" }};
                let currentMonth = latestMonth;

                function getThemeStyles() {
                    const body = document.body;
                    const theme = body.getAttribute("data-bs-theme");

                    return {
                        background: theme === "dark" ? "#212529" : "#ffffff",
                        textColor: theme === "dark" ? "#ffffff" : "#000000"
                    };
                }

                function fetchBubbleData(month) {
                    fetch(`/ecopoints/bubble-data/${month}/`)
                        .then(response => response.json())
                        .then(data => {
                            console.log("Updated Bubble Data:", data.bubble_data);
                            updateBubbleChart(data.bubble_data, month);
                        })
                        .catch(error => console.error("Error fetching bubble data:", error));
                }

                function updateBubbleChart(bubbleData, month) {
                    if (bubbleData.length === 0) {
                        console.warn("No data available for this month.");
                        document.getElementById("bubble-plot").innerHTML = "<p>No data available for this month.</p>";
                        return;
                    }

                    const themeStyles = getThemeStyles();

                    const bubblePlot = {
                        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                        "description": "Daily ecopoints by Category" + month,
                        "width": 500,
                        "height": 300,
                        "background": themeStyles.background,
                        "data": { "values": bubbleData },
                        "mark": "circle",
                        "encoding": {
                            "x": {
                                "field": "day",
                                "type": "ordinal",
                                "axis": {
                                    "title": "Day of the Month",
                                    "labelColor": themeStyles.textColor,
                                    "titleColor": themeStyles.textColor
                                }
                            },
                            "y": {
                                "field": "category",
                                "type": "nominal",
                                "axis": {
                                    "title": "Category",
                                    "labelColor": themeStyles.textColor,
                                    "titleColor": themeStyles.textColor
                                }
                            },
                            "size": {
                                "field": "points",
                                "type": "quantitative",
                                "scale": {"range": [20, 500]},
                                "legend": {
                                    "disable": true
                                }
                            },
                            "color": {
                                "field": "category",
                                "type": "nominal",
                                "scale": {"scheme": "category20"},
                                "legend": {
                                    "title": "Category",
                                    "labelColor": themeStyles.textColor,
                                    "titleColor": themeStyles.textColor
                                }
                            },
                            "tooltip": [
                                {"field": "day", "type": "ordinal", "title": "Day"},
                                {"field": "category", "type": "nominal", "title": "Category"},
                                {"field": "points", "type": "quantitative", "title": "Total ecopoints"}
                            ]
                        },
                        "config": {
                            "title": {"color": themeStyles.textColor}
                        }
                    };

                    vegaEmbed("#bubble-plot", bubblePlot).catch(console.error);
                }

                function renderCharts() {
                    const themeStyles = getThemeStyles();

                    if (document.getElementById("annual-histogram") && typeof vegaEmbed !== "undefined") {
                        const monthNames = {
                            1: "January", 2: "February", 3: "March", 4: "April",
                            5: "May", 6: "June", 7: "July", 8: "August",
                            9: "September", 10: "October", 11: "November", 12: "December"
                        };

                        let annualPointsData = {{ annual_points|safe }};

                        annualPointsData = annualPointsData.map(entry => ({
                            month: monthNames[entry.month],  // Convert number to name
                            points: entry.points
                        }));

                        const annualHistogram = {
                            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                            "description": "Annual Ecopoints",
                            "width": 300,
                            "height": 300,
                            "background": themeStyles.background,
                            "data": { "values": annualPointsData },
                            "mark": "bar",
                            "encoding": {
                                "x": {
                                    "field": "month",
                                    "type": "ordinal",
                                    "axis": {
                                        "title": "",
                                        "labelColor": themeStyles.textColor,
                                        "titleColor": themeStyles.textColor
                                    },
                                    "sort": [
                                        "January", "February", "March", "April", "May", "June",
                                        "July", "August", "September", "October", "November", "December"
                                    ]
                                },
                                "y": {
                                    "field": "points",
                                    "type": "quantitative",
                                    "axis": {
                                        "title": "ecopoints",
                                        "labelColor": themeStyles.textColor,
                                        "titleColor": themeStyles.textColor
                                    }
                                },
                                "color": {
                                    "field": "month",
                                    "type": "nominal",
                                    "legend": {
                                        "title": "Month (clickable bars)",
                                        "labelColor": themeStyles.textColor,
                                        "titleColor": themeStyles.textColor
                                    }
                                },
                                "tooltip": [
                                    {"field": "month", "type": "ordinal", "title": "Month"},
                                    {"field": "points", "type": "quantitative", "title": "Total ecopoints"}
                                ]
                            }
                        };

                        vegaEmbed("#annual-histogram", annualHistogram).then(result => {
                            result.view.addEventListener("click", (event, item) => {
                                if (item && item.datum) {
                                    const selectedMonth = item.datum.month;
                                    console.log("Selected Month:", selectedMonth);
                                    fetchBubbleData(selectedMonth);
                                }
                            });
                        }).catch(console.error);
                    }

                    fetchBubbleData(currentMonth);
                }

                renderCharts();

                const observer = new MutationObserver(renderCharts);
                observer.observe(document.body, { attributes: true, attributeFilter: ["data-bs-theme"] });
            {% endif %}
        };
    </script>


{% endblock %}
